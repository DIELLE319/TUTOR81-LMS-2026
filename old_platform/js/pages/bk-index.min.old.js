$(document).ready(function(){var e;var g=0.22;var b;var f;var d=function(h,i,j){h.each(function(){var n=$(this);var l=n.find(".amountRange").html().trim().split("-");var m=parseInt(l[0]);var k=parseInt(l[1]);if(i>=m&&i<=k){j=n.find(".amountPrice").html().substring(2).trim()}});return j};var c=function(i,h){console.log("Enter in setInviaLicenzeRow");e=i.parent("td").parent("tr").next(".inviaLicenzeRow").find(".sendLiceneceRowsContainer");console.log(e);if(h==1){var j=$(e.find(".inviaRows")[0]).clone(true,true);console.log(j);j.find(".inviaRows").attr("value",3);j.find("input[type='text']").val("");j.find("input.datepickers").removeClass("hasDatepicker").removeData("datepicker").unbind().datepicker({autoclose:true,beforeShow:function(){setTimeout(function(){$(".ui-datepicker").css("z-index",99999999999999)},0)}});e.append(j)}else{if(h==-1){e.find(".inviaRows").last().remove()}}};$(".checkout-vendi").click(function(){$(".tab-content").css({"background-color":"#394263",color:"#fff"});$(".wizard-steps .col-sm-4 div").removeClass("active");$(".wizard-steps").find("a").css("color","#000");var i=$("#nuovoUtenteTab");i.addClass("active");i.find("a").css("color","#fff");$(".tab-content .tab-pane").removeClass("active");var j=$("#nuovoUtente");j.addClass("active");console.log($(this).attr("id"));var k=$("#invia_Licenze_Modal").modal();var m=$(this).siblings(".rowLearningProjectID").val();console.log("rowLearningProjectID: "+m);var h=k.find(".learningProjectID").val(m);console.log(h.val());var l=$("#ecom-orders").find('.rowLearningProjectID[value="'+m+'"]').parent("td").parent("tr");console.log(l);f=$("#modalSellTitle").text(l.find(".courseTitle").text());console.log(f)});$(function(){$(".datepickers").datepicker({autoclose:true,beforeShow:function(){setTimeout(function(){$(".ui-datepicker").css("z-index",99999999999999)},0)}})});$(function(){$(".start_date").datepicker().datepicker("setDate",new Date());$(".end_date").datepicker().datepicker("setDate",new Date(new Date().setFullYear(new Date().getFullYear()+1)))});if($(".initialQuantita").val()==1){$(".decQuantita").prop("disabled",true);$(".licenseInfo").css("display","none");$(".licenseInfoVertical").css("display","");$(".licenseInfoVerticalAbs").css("display","");$(".inviaRows div:first-child").removeClass("email-field");$(".inviaRows div:nth-child(2)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(3)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(4)").removeClass("alert-field");$(".inviaRows div:nth-child(5)").removeClass("info-optional-field-cognome");$(".inviaRows div:nth-child(6)").removeClass("info-optional-field");$(".inviaRows div:nth-child(7)").removeClass("info-optional-field");$(".inviaRows div:nth-child(8)").removeClass("users-field");$(".inviaRows .form-group label").removeClass("hidden");$(".inviaRows .form-group input").removeClass("license-row-input");$(".inviaRows .needed-fields").addClass("verticalRowWidth");$(".inviaRows .optional-fields").addClass("verticalRowWidth");$(".inviaRows div:nth-child(5)").addClass("position-abs-cognome");$(".inviaRows div:nth-child(6)").addClass("position-abs-nome");$(".inviaRows div:nth-child(7)").addClass("position-abs-tax-code");$(".inviaRows div:nth-child(8)").addClass("position-abs-utente");$(".inviaRows .form-control").css("width","50%");$(".inviaRows").removeClass("form-group-optional");$(".inviaRows .license-email-icon").css("display","");$(".inviaRows .license-start-date-icon").css("display","");$(".inviaRows .license-end-date-icon").css("display","");$(".inviaRows .license-alert-icon").css("display","");$(".inviaRows").css("padding-top","10px")}$(".dec").on("click",function(){var m=$(this).parent("td").find(".productQuantita");var i=$(this).parent("td").find(".dec");var h=$(this).parent("td").parent("tr").find(".productPriceListRow");var k=$(this).parent("td").parent("tr").find(".productPrice").text();var l=$(this).parent("td").parent("tr").find(".tuoCosto");var j=parseInt(m.val())-1;if(j==1){i.prop("disabled",true);$(".licenseInfo").css("display","none");$(".licenseInfoVerticalAbs").css("display","");$(".inviaRows").css({display:"","padding-top":"10px"});$(".inviaRows .needed-fields").addClass("verticalRowWidth");$(".inviaRows .optional-fields").addClass("verticalRowWidth");$(".inviaRows div:nth-child(5)").addClass("position-abs-cognome");$(".inviaRows div:nth-child(6)").addClass("position-abs-nome");$(".inviaRows div:nth-child(7)").addClass("position-abs-tax-code");$(".inviaRows div:nth-child(8)").addClass("position-abs-utente");$(".inviaRows div:first-child").removeClass("email-field");$(".inviaRows div:nth-child(2)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(3)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(4)").removeClass("alert-field");$(".inviaRows div:nth-child(5)").removeClass("info-optional-field-cognome");$(".inviaRows div:nth-child(6)").removeClass("info-optional-field");$(".inviaRows div:nth-child(7)").removeClass("info-optional-field");$(".inviaRows div:nth-child(8)").removeClass("users-field");$(".inviaRows .form-group label").removeClass("hidden");$(".inviaRows .form-group input").removeClass("license-row-input");$(".inviaRows .license-email-icon").css("display","");$(".inviaRows .license-start-date-icon").css("display","");$(".inviaRows .license-end-date-icon").css("display","");$(".inviaRows .license-alert-icon").css("display","");$(".inviaRows .form-control").css("width","50%");$(".inviaRows").removeClass("form-group-optional")}m.val(j);k=d(h,j,k);l.html("&euro; "+String(k).replace(".",","));c($(this),-1)});$(".inc").on("click",function(){$(".licenseInfo").css("display","inline-flex");$(".licenseInfoVerticalAbs").css("display","none");$(".inviaRows").css({display:"inline-flex","padding-top":"0"});$(".inviaRows .form-group").removeClass("verticalRowWidth");$(".inviaRows div:first-child").addClass("email-field");$(".inviaRows div:nth-child(2)").addClass("startEndDate-field");$(".inviaRows div:nth-child(3)").addClass("startEndDate-field");$(".inviaRows div:nth-child(4)").addClass("alert-field");$(".inviaRows div:nth-child(5)").addClass("info-optional-field-cognome");$(".inviaRows div:nth-child(6)").addClass("info-optional-field");$(".inviaRows div:nth-child(7)").addClass("info-optional-field");$(".inviaRows div:nth-child(8)").addClass("users-field");$(".inviaRows .form-control").removeAttr("style");$(".inviaRows div:nth-child(5)").removeClass("position-abs-cognome");$(".inviaRows div:nth-child(6)").removeClass("position-abs-nome");$(".inviaRows div:nth-child(7)").removeClass("position-abs-tax-code");$(".inviaRows div:nth-child(8)").removeClass("position-abs-utente");$(".inviaRows .form-group label").addClass("hidden");$(".inviaRows .form-group input").addClass("license-row-input");$(".inviaRows .license-email-icon").css("display","none");$(".inviaRows .license-start-date-icon").css("display","none");$(".inviaRows .license-end-date-icon").css("display","none");$(".inviaRows .license-alert-icon").css("display","none");$(".inviaRows").addClass("form-group-optional");var m=$(this).parent("td").find(".productQuantita");var i=$(this).parent("td").find(".dec");var h=$(this).parent("td").parent("tr").find(".productPriceListRow");var k=$(this).parent("td").parent("tr").find(".productPrice").text();var l=$(this).parent("td").parent("tr").find(".tuoCosto");var j=parseInt(m.val())+1;m.val(j);i.prop("disabled",false);k=d(h,j,k);l.html("&euro; "+String(k).replace(".",","));c($(this),1)});$(".productQuantita").on("change",function(){console.log("Enter in productQuantitaChange");var l=$(this).parent("td").find(".productQuantita");var h=$(this).parent("td").parent("tr").find(".productPriceListRow");var j=$(this).parent("td").parent("tr").find(".productPrice").text();var k=$(this).parent("td").parent("tr").find(".tuoCosto");var i=parseInt(l.val());j=d(h,i,j);k.html("&euro; "+String(j).replace(".",","))});$(function(){$(".alert_dec").unbind("click");$(".alert_dec").click(function(){var i=$(this).parent("div").children(".alert_dec");var j=$(this);var h=parseInt(j.siblings(".alert_days_amount").val())-1;if(h==1){i.prop("disabled",true)}j.siblings(".alert_days_amount").val(h)});$(".alert_inc").unbind("click");$(".alert_inc").click(function(){var i=$(this);var h=parseInt(i.siblings(".alert_days_amount").val())+1;$(".alert_dec").prop("disabled",false);i.siblings(".alert_days_amount").val(h)})});$(".sell").on("click",function(){var n=$(this).parentsUntil(".modal-body").find(".wizard-steps").find(".active");var m=$("#ecom-licences");var j=m.find(".learningProjectID").val();console.log("CourseID: "+j);$.isLoading({text:"Attendere prego ..."});var p=$("#ecom-orders tr").find('.rowLearningProjectID[value="'+j+'"]').parent("td").parent("tr");console.log(p);var i=$("#userID").val();var w=$("#tutorCompanyID").val();var s=$("#tutorEmail").val();b=$("#clienteCompanyID").val();console.log("customer_company_id: "+b);var q=0;var o=p.find(".productId").text();console.log("learning_project_id: "+o);var x=0;var y;var t;var z;var v=function(){return t.replace(",",".")*y};var r=function(){return v()*g};var l="backend";console.log("Payment type: "+l);var h=$(this);var k;if(n.attr("id")!="nuovoUtenteTab"){console.log("INVIA LICENZE NUOVO UTENTE");k=$(".employee-table-body").children("tr").filter(function(A){var B=$(this).find(".select-checkbox");if(B.is(":checked")){return A}});console.log("Row licences list:");console.log(k);y=k.length;console.log("Numero di licenze generato: "+y);t=p.find(".productPrice").text();console.log("Prezzo di vendita: "+t);z=r()+v();console.log("Totale della vendita: "+z);console.log("Inizio generazione della nuova vendita...");$.post("/ecommerce/license.php",{op_type:"new_ecommercetutorbackend_purchase",tutorid:i,customercompany_id:b,usercompany_ref:q,learningproject_id:o,amount:y,costcentre_id:x,price:z,payment:l,email:s}).done(function(B){console.log("Completata generazione della nuova vendita.");var A=B;console.log("Codice della nuova vendita: "+B);console.log("Inizio generazione ed invio dei codici corso agli utenti...");if(A>0){k.each(function(){console.log("Riga della tabella:");console.log($(this));var F=$(this);var K="";var H=new Date;console.log(H);var N=new Date(new Date().setFullYear(new Date().getFullYear()+1));console.log(N);var G=15;var C="";var O="";var M="";var L="";var E="";var D="";var J="";var I=F.find(".licenceIDUser").text();console.log("UsesID assegnatario: "+I);$.post("/ecommerce/license.php",{op_type:"new_ecommercetutorbackend_assignment",tutorid:i,purchase_id:A,turor_userid:i,user_companyid:b,learningproject_id:o,learningproject_data_inizio:H,learningproject_data_fine:N,user_alert_days:G,user_nome:C,user_cognome:O,user_cod_fisc:M,user_data_assunzione:L,user_unita:E,user_reparto:D,user_tipo_utente:J,user_email:K,user_id:I}).done(function(P){console.log(P);console.log("Corso venduto....")})});alert("Ti confermiamo l'invio di numero "+y+" licenza/e per il seguente corso: "+f.text()+".");location.reload(true)}else{$.isLoading("hide");alert("Non è stato possibile completare la vendita, si prega di contattare il servizio di assistenza della piattaforma.");location.reload(true)}})}else{console.log("INVIA LICENZE NUOVO UTENTE");k=$("#sendLicenceForm").find(".sendLiceneceRowsContainer");console.log("Row licences list:");console.log(k);var u=false;k.find(".inviaRows").each(function(){if($(this).find(".email").val()==""&&$(this).find(".email").css("border","1px solid red")){$(this).find(".email").css("border","1px solid red");u=true}var C=$(this).find(".cognome");var A=$(this).find(".nome");var B=$(this).find(".cod_fisc");if(C.val()!=""||A.val()!=""||B.val()!=""){if(C.val()==""){C.css("border","1px solid red");u=true}if(A.val()==""){A.css("border","1px solid red");u=true}if(B.val()==""){B.css("border","1px solid red");u=true}}});if(u){alert("Completate tutti i campi obbligatori segnalati in rosso.");$.isLoading("hide");return false}y=m.find(".productQuantita").val();console.log("Numero di licenze generato: "+y);t=p.find(".productPrice").text();console.log("Prezzo di vendita: "+t);z=r()+v();console.log("Totale della vendita: "+z);console.log("Inizio generazione della nuova vendita...");$.post("/ecommerce/license.php",{op_type:"new_ecommercetutorbackend_purchase",tutorid:i,customercompany_id:b,usercompany_ref:q,learningproject_id:o,amount:y,costcentre_id:x,price:z,payment:l,email:s}).done(function(B){console.log("Completata generazione della nuova vendita.");var A=B;console.log("Codice della nuova vendita: "+B);if(A>0){k.find(".inviaRows").each(function(){console.log($(this));var F=$(this);var K=F.find(".email").val();console.log(K);var H=F.find(".data_inizio").val();var N=F.find(".data_fine").val();var G=F.find(".alert_days").val();var C=F.find(".nome").val();var O=F.find(".cognome").val();var M=F.find(".cod_fisc").val();var L=F.find(".data_assunzione").val();var E=F.find(".unita").val();var D=F.find(".reparto").val();var J=F.find(".tipo_utente").val();var I=F.find(".licenceIDUser").val();$.post("/ecommerce/license.php",{op_type:"new_ecommercetutorbackend_assignment",tutorid:i,purchase_id:A,turor_userid:i,user_companyid:b,learningproject_id:o,learningproject_data_inizio:H,learningproject_data_fine:N,user_alert_days:G,user_nome:C,user_cognome:O,user_cod_fisc:M,user_data_assunzione:L,user_unita:E,user_reparto:D,user_tipo_utente:J,user_email:K,user_id:I}).done(function(P){console.log(P);console.log("Corso venduto....")})});alert("Ti confermiamo l'invio di numero "+y+" licenza/e per il seguente corso: "+f.text()+".");location.reload(true)}else{$.isLoading("hide");alert("Non è stato possibile completare la vendita, si prega di contattare il servizio di assistenza della piattaforma.")}})}return false});$(".email").keypress(function(){$(this).focusout(function(){$(this).filter(function(h){var j=$(this).val();var i=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;if(!i.test(j)){$(this).css("border-color","red");alert("Inserisci una email valida.");h.preventDefault()}else{$(this).css("border-color","#dbe1e8")}});return false})});$(function(){$(".select-type-unita li a").click(function(){$("#unita:first-child").text($(this).text());$("#unita:first-child").val($(this).text())});$(".select-type-reparto li a").click(function(){$("#reparto:first-child").text($(this).text());$("#reparto:first-child").val($(this).text())});$(".select-type-utente li a").click(function(){$("#utente:first-child").text($(this).text());$("#utente:first-child").val($(this).text())})});$(".blockedKey").on("click",function(){$.isLoading({text:"Attendere prego ..."});if($(this).parent("td").prev("td").children("span.blocked").css("display")!="none"){$(this).parent("td").prev("td").children("span.sold").html(" Sblocatto").show().siblings("span").hide();$(this).parent("td").children("a.write").show().siblings("a").hide();$(this).parent("td").children("button.blockedKey").html(" Sblocca").hide()}console.log("sblocca licenza inviando mail del corso e assegnata dopo iscrizione del corsista");console.log($(this).parent("td").parent("tr").find(".lpuid").val());$.post("/ecommerce/bk/unlock_licence.php",{lpu_id:$(this).parent("td").parent("tr").find(".lpuid").val()}).done(function(h){console.log(h);console.log("Inviata iscrizione al corsro....");location.reload(true);$.isLoading("hide")})});$("#search-employee .search-query").autocomplete({source:"lib/employee_search.php?option=&istutor="+$("#isTutor").val()+"&companyid="+$("#companyID").val(),minLength:2,select:function(i,j){console.log("ritorno search ....");console.log(j);var h=j.item.id;if(h>0){$("#single-user").html('<img src="img/loading_gif.gif"><p>caricamento in corso ...</p>').load("pages/sections/employee-detail.php",{user_id:h});$("#cerca-utenti-modal").modal()}},html:true,open:function(h,i){$(".ui-autocomplete").css("z-index",1000)}});$("body").on("hidden.bs.modal",".modal",function(){$("#search-employee").find("input[type='text']").val("");$("#clienteCompanyID option:selected").prop("selected",false);$("#clienteCompanyID option:first").prop("selected","selected");var h=$(".productQuantita").val("1");var i=$(".dec");i.prop("disabled",true);$(".inviaRows").prevUntil(e).remove();if(h.val()==1){i.prop("disabled",true);$(".licenseInfo").css("display","none");$(".licenseInfoVerticalAbs").css("display","");$(".inviaRows").css({display:"","padding-top":"10px"});$(".inviaRows .form-group").addClass("verticalRowWidth");$(".inviaRows div:first-child").removeClass("email-field");$(".inviaRows div:nth-child(2)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(3)").removeClass("startEndDate-field");$(".inviaRows div:nth-child(4)").removeClass("alert-field");$(".inviaRows div:nth-child(5)").removeClass("info-optional-field-cognome");$(".inviaRows div:nth-child(6)").removeClass("info-optional-field");$(".inviaRows div:nth-child(7)").removeClass("info-optional-field");$(".inviaRows div:nth-child(8)").removeClass("users-field");$(".inviaRows div:nth-child(5)").addClass("position-abs-cognome");$(".inviaRows div:nth-child(6)").addClass("position-abs-nome");$(".inviaRows div:nth-child(7)").addClass("position-abs-tax-code");$(".inviaRows div:nth-child(8)").addClass("position-abs-utente");$(".inviaRows .form-group label").removeClass("hidden");$(".inviaRows .form-group input").removeClass("license-row-input");$(".inviaRows .license-email-icon").css("display","");$(".inviaRows .license-start-date-icon").css("display","");$(".inviaRows .license-end-date-icon").css("display","");$(".inviaRows .license-alert-icon").css("display","");$(".inviaRows .form-control").css("width","50%");$(".inviaRows").removeClass("form-group-optional")}$(".inviaRows").find("input[type='email'], input[type='text']").val("");$(".inviaRows").find(".email").css("border-color","#dbe1e8");$(".start_date").datepicker().datepicker("setDate",new Date());$(".end_date").datepicker().datepicker("setDate",new Date(new Date().setFullYear(new Date().getFullYear()+1)));$(this).find(".alert_days_amount").val("15");$(this).find("#tipoUtente select").first().val("0")});$(".wizard-steps a").click(function(i){$(".wizard-steps .col-sm-4 div").removeClass("active");$(".wizard-steps").find("a").css("color","#000");var h=$(this).parent().parent();if(!h.hasClass("active")){h.addClass("active");h.find("a").css("color","#fff");h.find("a").css("color","#fff");$("#ecom-licences").find(".email").css("border-color","#dbe1e8")}i.preventDefault()});$("#utenteEsistenteTab").click(function(){$(".tab-content").css({"background-color":"#fff",color:"#000"})});$("#nuovoUtenteTab").click(function(){$(".tab-content").css({"background-color":"#394263",color:"#fff"})});$(".pu_select").on("change",function(){var h=$(this).val();a(h,0)});var a=function(o,j){console.log("------- Chiamata alla refresh Table...");var h=$("#clienteCompanyID").val();console.log("Company id nella refresh: "+h);var i=$("#ecom-licences");var n=i.find(".learningProjectID").val();var k=$("#ecom-orders tr").find('.rowLearningProjectID[value="'+n+'"]').parent("td").parent("tr");console.log("CourseID: "+n);var m=k.find(".productId").text();console.log("Learning project ID: "+m);var l=$("#employees-table").DataTable();l.clear().draw();$.get("lib/employee_search.php?option=employees&term=&learningprojectid="+m+"&companyid="+h+"&unita="+o+"&reparto="+j,function(q){console.log(q);console.log("Ritornata nuova lista utenti:");var p=$.parseJSON(q);console.log(p);l.rows.add(p);l.draw()})};$("#utenteEsistenteTabLink").on("click",function(){$("select[name=department]").addClass("hidden");var h=$("#clienteCompanyID").val();console.log("Company id: "+h);$(".product_unit > div.dep_controls").empty();$.post("manage/department.php",{op_type:"get_pu",pu_id:h},function(k){var j='<option value="0">Seleziona unità</option>';k=$.parseJSON(k);if(k==0){$(".product_unit > div.pu_controls select").empty().append(j)}else{$.each(k,function(l,m){j+='<option value="'+m.id_pu+'">'+m.short_desc_pu+"</option>";if(l==Object.keys(k).length-1){$(".product_unit > div.pu_controls select").empty().append(j)}})}var i=$(".pu_select option").length;console.log("LengthAfterPost "+i);if(i>1){$(".pu_select").removeClass("hidden");$("#employees-table").DataTable().clear().draw()}else{$(".pu_select").addClass("hidden");a(0,0)}})});$("#clienteCompanyID").on("change",function(){console.log("Change company...");$("select[name=department]").addClass("hidden");var j=$("#utenteEsistenteTab").attr("class");console.log("Change...");console.log(j);if(j=="active"){console.log("Active...");var h=$("#clienteCompanyID").val();console.log("Company ids: "+h);var i=$("#employees-table").DataTable();$(".product_unit > div.dep_controls").empty();$.post("manage/department.php",{op_type:"get_pu",pu_id:h},function(m){var l='<option value="0">Seleziona unità</option>';m=$.parseJSON(m);if(m==0){$(".product_unit > div.pu_controls select").empty().append(l)}else{$.each(m,function(n,o){l+='<option value="'+o.id_pu+'">'+o.short_desc_pu+"</option>";if(n==Object.keys(m).length-1){$(".product_unit > div.pu_controls select").empty().append(l)}})}var k=$(".pu_select option").length;console.log("LengthAfterPost "+k);if(k>1){$(".pu_select").removeClass("hidden");$("#employees-table").DataTable().clear().draw()}else{$(".pu_select").addClass("hidden");a(0,0)}})}});$('select[name="product_unit"]').on("change",function(){console.log("Product unit id: "+$('select[name="product_unit"]').val());if($('select[name="product_unit"]').val()==0){$(".departments > div.dep_controls").empty()}else{$.post("manage/department.php",{op_type:"get_pu_departments",pu_id:$('select[name="product_unit"]').val()},function(i){var h='<select title="Reparto" class="form-control" size="1" name="department" ><option value="0">Seleziona reparto</option>';i=$.parseJSON(i);if(i==0){$(".departments > div.dep_controls").empty().append(h+"</select>")}else{$.each(i,function(j,k){h+='<option value="'+k.id_dep+'">'+k.short_desc_dep_type+"</option>";if(j==Object.keys(i).length-1){$(".departments > div.dep_controls").empty().append(h+"</select>")}});$("select[name=department]").on("change",function(){var k=$('select[name="product_unit"]').val();var j=$(this).val();a(k,j)})}})}});$("#masterCheckbox").click(function(){$("input:checkbox").not(this).prop("checked",this.checked)})});