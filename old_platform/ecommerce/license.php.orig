<?php
/**
 * Created by PhpStorm.
 * User: Davide
 * Date: 18/01/2017
 * Time: 23.26
 */

require_once '../config.php';
require_once BASE_LIBRARY_PATH . 'class_purchase.php';
require_once BASE_LIBRARY_PATH . 'sanitize.php';

$purchase_obj = new iWDPurchase();

$op_type = filter_input(INPUT_POST, 'op_type', FILTER_SANITIZE_STRING, FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH);

$res = 0;

/**
 * NUOVA ASSEGNAZIONE
 */
if ($op_type === 'assign_new') {

    // se la data di inizio del corso non Ã¨ impostata definisco data di inizio, di fine e giorni di alert
    if (!isset($_POST['start'])) {
        require_once BASE_LIBRARY_PATH . 'class_learning_project.php';
        $learning_project_obj = new T81LearningProject();
        $learning_project = $learning_project_obj->getCourseDetailFromLearningProject($_POST['learn_prj']);
        $start_date = date("Y-m-d");
        $end_date = date("Y-m-d", strtotime($start_date . $learning_project['max_execution_time'] . 'days'));
        $alert = 15;
    } else {
        $start_date = $_POST['start'];
        $end_date = $_POST['end'];
        $alert = $_POST['alert'];
    }

    $res = $purchase_obj->createNewLicense($_POST['user_id'], $_POST['learn_prj'], $_POST['tutor_id'], $start_date, $end_date, $alert, $_POST['id_company'], $_POST['accreditation_code']);

    // invia notifica assegnazione
    require_once BASE_LIBRARY_PATH . 'class_notification.php';
    $not_obj = new Tutor81Notification();
    $not_obj->notifyCourseAssignment($res);

    /**
     * NUOVO ACQUISTO
     */
}
elseif ($op_type === 'new_ecommerce_purchase') {
    require_once BASE_LIBRARY_PATH . 'class_learning_project.php';
    $learning_project_obj = new T81LearningProject();

    $destination_email = $_POST['email'];
    $amount = $_POST['amount'];
    $learningproject_id = $_POST['learningproject_id'];
    $arr_ext_po_number = array("");
    $arr_cost_centre_id = array(0);
    $user_id = $_POST['usercompany_ref'];
    $tutor_id = $_POST['tutorid'];
    $company_id = $_POST['customercompany_id'];
    $accreditation_code = "";
    $payment_type = $_POST['payment'];

    // TODO: take max_execution time from database
    $learning_project = $learning_project_obj->getCourseDetailFromLearningProject($learningproject_id);
    $start_date = date("Y-m-d");
    $max_execution_time = "300";
    $end_date = date("Y-m-d", strtotime($start_date . $max_execution_time . 'days'));
    $alert = 15;
    $total = $_POST['price'];

    $purchase_id = $purchase_obj->purchaseCourse(
        $company_id,
        $learningproject_id,
        $amount,
        $user_id,
        $tutor_id,
        $arr_ext_po_number,
        $arr_cost_centre_id,
        0,
        $total
    );

    if ($purchase_id) {
        require_once BASE_LIBRARY_PATH . 'class_notification.php';
        require_once BASE_LIBRARY_PATH . 'class_learning_event.php';
        $not_obj = new Tutor81Notification();
        $ler_obj = new Tutor81LearningEvt();
        $not_obj->notifyPurchaseEcommerce($destination_email, $learning_project, $total, $purchase_id);
        // Generare un entry per ogni licenza con la quantita arrivata
        for($i = 0; $i < $amount; $i++) {
            $res = $purchase_obj->createNewEcommerceLicense(
                $user_id,
                $learningproject_id,
                $tutor_id,
                $start_date,
                $end_date,
                $alert,
                $company_id,
                $accreditation_code,
                $purchase_id
            );
//            $purchase_detail = $ler_obj->getPurchaseDetailById($res);
//            $not_obj->notifyUnlockLicenceEcommerce($purchase_detail, $destination_email, $learning_project, $i, $start_date, $end_date);
        }
    }
    $res = 1;


    /**
     * CALCOLA CORSI ELEARNING ACQUISTATI MA NON ASSEGNATI
     */
}
elseif ($op_type === 'new_ecommercetutorbackend_purchase') {
    require_once BASE_LIBRARY_PATH . 'class_notification.php';
    $not_obj = new Tutor81Notification();
    require_once BASE_LIBRARY_PATH . 'class_learning_project.php';
    $learning_project_obj = new T81LearningProject();

    $destination_email = $_POST['email'];
    $amount = $_POST['amount'];
    $learningproject_id = $_POST['learningproject_id'];
    $arr_ext_po_number = array("");
    $arr_cost_centre_id = array(0);
    $user_id = $_POST['usercompany_ref'];
    $tutor_id = $_POST['tutorid'];
    $company_id = $_POST['customercompany_id'];
    $accreditation_code = "";
    $payment_type = $_POST['payment'];
    $total = $_POST['price'];

    if ($user_id == "0") {
        require_once BASE_LIBRARY_PATH . 'class_user.php';
        $usr_obj = new T81User();
        // get the user from $company_id
        // getUserCompany
        $user_id = $usr_obj->getUserCompanyOwner($company_id);
    }

    $learning_project = $learning_project_obj->getCourseDetailFromLearningProject($learningproject_id);

    $purchase_id = $purchase_obj->purchaseCourse(
        $company_id,
        $learningproject_id,
        $amount,
        $user_id,
        $tutor_id,
        $arr_ext_po_number,
        $arr_cost_centre_id,
        0,
        $total
    );

    if ($purchase_id) {
        $emailsended = $not_obj->notifySellTutorFromBackend($destination_email, $learning_project, $total, $purchase_id);
        $res = $purchase_id;
    }
    else {
        $res = 0;
    }


    /**
     * CALCOLA CORSI ELEARNING ACQUISTATI MA NON ASSEGNATI
     */
}
elseif ($op_type === 'new_ecommercetutorbackend_assignment') {

    require_once BASE_LIBRARY_PATH . 'class_learning_project.php';

    $tutor_id = $_POST['tutorid'];
    $purchase_id = $_POST['purchase_id'];
    $turor_userid = $_POST['turor_userid'];
    $company_id = $_POST['user_companyid'];
    $learningproject_id = $_POST['learningproject_id'];
    $learningproject_data_inizio = $_POST['learningproject_data_inizio'];
    $learningproject_data_fine = $_POST['learningproject_data_fine'];
    $user_alert_days = $_POST['user_alert_days'];
    $user_nome = $_POST['user_nome'];
    $user_cognome = $_POST['user_cognome'];
    $user_cod_fisc = $_POST['user_cod_fisc'];
    $user_data_assunzione = $_POST['user_data_assunzione'];
    $user_unita = $_POST['user_unita'];
    $user_reparto = $_POST['user_reparto'];
    $user_tipo_utente = $_POST['user_tipo_utente'];
    $user_id = $_POST['user_id'];
    $destination_email= $_POST['user_email'];
    $learningproject_id = $_POST['learningproject_id'];
    $accreditation_code = "";
    $start_date =  $learningproject_data_inizio =="" ? date("Y-m-d") : $learningproject_data_inizio;
    $max_execution_time = "300";
    $new_end_date = date("Y-m-d", strtotime($start_date . $max_execution_time . 'days'));
    $end_date = $learningproject_data_fine == "" ? $new_end_date : $learningproject_data_fine;

    $learning_project_obj = new T81LearningProject();
    $learning_project = $learning_project_obj->getCourseDetailFromLearningProject($learningproject_id);

    if ($purchase_id) {
        require_once BASE_LIBRARY_PATH . 'class_notification.php';
        require_once BASE_LIBRARY_PATH . 'class_learning_event.php';
        require_once BASE_LIBRARY_PATH . 'class_user.php';
        $not_obj = new Tutor81Notification();
        $ler_obj = new Tutor81LearningEvt();
        $usr_obj = new T81User();

        $new_user = false;

        // Caso in cui la licenza vada inviata ad un indirizzo email ed anonima simile ad ecommerce
        if ($user_nome != "" || $user_cognome != "" || $user_cod_fisc != "") {
            if ($user_id > 0) {
                $new_user = false;
            }
            else {
                // Genero un nuovo utente con i dati postati
                require_once BASE_LIBRARY_PATH . 'function.php';
                $password = strtoupper($user_cod_fisc);
                $username = trim($user_nome).'.'.trim($user_cognome);

                try {
<<<<<<< local
                    $user_id = $usr_obj->createUser($turor_userid, 0, $user_nome, $user_cognome, $username,
                        $password, $destination_email, $company_id, $user_cod_fisc, "0");
=======
                    $user_id = $usr_obj->createUser($turor_userid, 0, $user_nome, $user_cognome,
                        $username, $password, $destination_email, $company_id, $user_cod_fisc, "0");
>>>>>>> other
                    if(!is_numeric($user_id)) {
                        echo $user_id;
                    }
                    $new_user = true;
                }
                catch (Exception $e) {
                    return $e->getMessage();
                }
            }

        }
        else {
            $new_user = true;
        }

        // Genero la licenza e la invio al destinatario
        $res = $purchase_obj->createNewEcommerceLicense(
            $user_id,
            $learningproject_id,
            $tutor_id,
            $start_date,
            $end_date,
            $user_alert_days,
            $company_id,
            $accreditation_code,
            $purchase_id
        );
        $purchase_detail = $ler_obj->getPurchaseDetailById($res);
        $not_obj->notifyUnlockLicenceEcommerce($purchase_detail, $destination_email, $learning_project, $i, $start_date, $end_date, $new_user);
    }
}
elseif ($op_type === 'get_elearning_purchase_unassigned'){
    $res = $purchase_obj->countElearningProjectUnassigned($_POST['company_id'], $_POST['learning_project_id']);


    /**
     * RIMUOVI ACQUISTO
     */
}
elseif ($op_type === 'remove_license') {

    $res = $purchase_obj->removePurchaseCourse($_POST['purchase_id'], $_POST['license_qta']);


    /**
     * INVIA NOTIFCA ASSEGNAZIONE CORSO
     */
}
elseif ($op_type === 'notify_course_assignment') {

    require_once BASE_LIBRARY_PATH . 'class_notification.php';
    $not_obj = new Tutor81Notification();
    $sending = $not_obj->notifyCourseAssignment($_POST['license_id']);
    $res = $sending['result'] ? 1 : 0;


    /**
     * INVIA ALERT
     */
}
elseif ($op_type === 'send_alert') {

    require_once BASE_LIBRARY_PATH . 'class_notification.php';
    $not_obj = new Tutor81Notification();
    if ($not_obj->notifyAlert($_POST['license_id'], $_POST['custom_message']) == true)
        $res = 1;
    else
        $res = 0;


    /**
     * INVIO AUTOMATICO ALERT
     */
}
elseif ($op_type === 'auto_alert') {
    $licenses_expiring = $purchase_obj->getLicenseExpiring();

    if ($licenses_expiring) {
        require_once BASE_LIBRARY_PATH . 'class_notification.php';
        $not_obj = new Tutor81Notification();
        $res = 0;
        foreach ($licenses_expiring as $license) {
            $res += (int) $not_obj->notifyAlert($license['id']);
        }
    }

    /**
     * ISCRIZIONE MULTIPLA
     */
}
elseif ($op_type === 'subscribe') {
    $total_purchased = 0;
    if ($_POST['to_buy'] !== "false") {
        if (filter_input(INPUT_POST,'packed', FILTER_SANITIZE_NUMBER_INT) > 0) {
            $to_buy = filter_input(INPUT_POST, 'to_buy', FILTER_SANITIZE_NUMBER_INT);
            require_once BASE_LIBRARY_PATH . 'class_pack.php';
            $pack_obj = new T81Pack();
            $pack_purchased = $pack_obj->getCurrentPackPurchased($_POST['tutor_company_id']);
            $learning_project_price_duration = $pack_obj->getElearningPriceDuration($_POST['learning_project_id']);
            foreach ($pack_purchased as $pack) {
                if ($to_buy <= 0) break;
                if ($pack['content_type'] === 'COURSES') {
                    $available = $pack['content_available'];
                    $to_purchase = $available >= $to_buy ? $to_buy : $available;
                    $to_reduce = $to_purchase;
                } elseif ($pack['content_type'] === 'HOURS' && (integer) $learning_project_price_duration['duration'] > 0) {
                    $available = $pack['content_available']/((integer) $learning_project_price_duration['duration']);
                    $to_purchase = $available >= $to_buy ? $to_buy : $available;
                    $to_reduce = $to_purchase*((integer) $learning_project_price_duration['duration']);
                } elseif ($pack['content_type'] === 'MONEY' && $learning_project_price_duration['price'] > 0) {
                    $available = floor($pack['content_available']/$learning_project_price_duration['price']);
                    $to_purchase = $available >= $to_buy ? $to_buy : $available;
                    $to_reduce = $to_purchase*$learning_project_price_duration['price'];
                }
                $purchased = $purchase_obj->purchaseCourse($_POST['company_id'], $_POST['learning_project_id'],
                    $to_purchase, $_POST['user_company_ref'], $_POST['tutor_id'],
                    $_POST['ext_po_number'], $_POST['cost_centre'], $pack['id_pack_purchase']);
                if ($purchased) {
                    $to_buy -= $to_purchase;
                    // riduco il content available del pack
                    $pack_obj->setContentAvialablePackPurchased($pack['id_pack_purchase'], $pack['content_available'] - $to_purchase);

                }
            }
        } else {
            $purchased = $purchase_obj->purchaseCourse($_POST['company_id'], $_POST['learning_project_id'],
                $_POST['to_buy'], $_POST['user_company_ref'], $_POST['tutor_id'],
                $_POST['ext_po_number'],$_POST['cost_centre']);
        }
    }

    $res = array();
    foreach ($_POST['users'] as $user_id) {
        $license_id = $purchase_obj->createNewLicense($user_id, $_POST['learning_project_id'], $_POST['tutor_id'], $_POST['start'], $_POST['end'], $_POST['alert'], $_POST['company_id']);
        array_push($res, $license_id);
    }

    $res = !empty($res) ? json_encode($res) : 0;


    /**
     * MODIFICA SCADENZA CORSO
     */
}
elseif ($op_type === 'schedule_license') {
    $res = $purchase_obj->scheduleLicense($_POST['license_id'], $_POST['starting_from'], $_POST['finish_within'], $_POST['days_to_alert']);
    if ($res && $_POST['send_mail'] === "true") {
        require_once BASE_LIBRARY_PATH . 'class_notification.php';
        $not_obj = new Tutor81Notification();
        $not_obj->notifyLicenseExpirationDate($_POST['license_id']);
    }
}

echo $res;